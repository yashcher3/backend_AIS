# from sqlalchemy import Column, Integer, String, Text, ForeignKey, DateTime
# from sqlalchemy.ext.declarative import declarative_base
# from sqlalchemy.orm import relationship
# from pydantic import BaseModel, field_validator
# from typing import List, Optional
# from datetime import datetime
#
# Base = declarative_base()
#
#
# # SQLAlchemy –º–æ–¥–µ–ª–∏ –¥–ª—è –ë–î - –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–´ –¢–ê–ë–õ–ò–¶–´
# class DBCaseTemplate(Base):
#     __tablename__ = "case_templates"  # –ë–´–õ–û: "cases"
#
#     id = Column(Integer, primary_key=True, index=True)
#     name = Column(String, nullable=False)
#     description = Column(Text)
#     stages_list = Column(Text)  # JSON —Å–ø–∏—Å–æ–∫ ID —ç—Ç–∞–ø–æ–≤
#
#     stages = relationship("DBStageTemplate", back_populates="case_template")
#
#
# class DBStageTemplate(Base):
#     __tablename__ = "stage_templates"  # –ë–´–õ–û: "stages"
#
#     id = Column(String, primary_key=True, index=True)  # —Ñ–æ—Ä–º–∞—Ç: {case_id}.{stage_number}
#     case_template_id = Column(Integer, ForeignKey('case_templates.id'))  # –ë–´–õ–û: case_id
#     name_stage = Column(String, nullable=False)
#     file_fields = Column(Integer, default=0)
#     text_fields = Column(Integer, default=0)
#     desc = Column(Text)
#     duration = Column(String)
#     condition = Column(Text, nullable=True)
#
#     case_template = relationship("DBCaseTemplate", back_populates="stages")  # –ë–´–õ–û: case
#     attribute_templates = relationship("DBAttributeTemplate", back_populates="stage_template")
#
#
# class DBAttributeTemplate(Base):
#     __tablename__ = "attribute_templates"
#
#     id = Column(Integer, primary_key=True, index=True)
#     stage_template_id = Column(String, ForeignKey('stage_templates.id'))  # –ë–´–õ–û: stage_id
#     field_type = Column(String)  # 'file_field', 'text_field'
#     field_index = Column(Integer)  # –ù–æ–º–µ—Ä –ø–æ–ª—è (1, 2, 3...)
#     label = Column(String)  # –ü–æ–¥–ø–∏—Å—å/–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è
#     created_at = Column(DateTime, default=datetime.utcnow)
#
#     stage_template = relationship("DBStageTemplate", back_populates="attribute_templates")  # –ë–´–õ–û: stage
#
#
# class DBExecutor(Base):
#     __tablename__ = "executors"
#
#     id = Column(Integer, primary_key=True, index=True)
#     login = Column(String, unique=True, index=True, nullable=False)
#     full_name = Column(String, nullable=False)
#     expert_area = Column(String)
#     created_by = Column(String)
#
#
# # Pydantic –º–æ–¥–µ–ª–∏ –¥–ª—è API - –û–ë–ù–û–í–õ–ï–ù–´ –°–í–Ø–ó–ò
# class AttributeTemplateBase(BaseModel):
#     field_type: str
#     field_index: int
#     label: str
#
#
# class AttributeTemplateCreate(AttributeTemplateBase):
#     stage_template_id: str  # –ë–´–õ–û: stage_id
#
#
# class AttributeTemplateResponse(AttributeTemplateBase):
#     id: int
#     stage_template_id: str  # –ë–´–õ–û: stage_id
#
#
# class StageTemplateBase(BaseModel):  # –ë–´–õ–û: StageBase
#     id: str
#     name_stage: str
#     file_fields: int = 0
#     text_fields: int = 0
#     desc: str
#     duration: str
#     condition: Optional[str] = None
#     children: Optional[List[str]] = None
#
#     @field_validator('file_fields', 'text_fields')
#     @classmethod
#     def validate_non_negative(cls, v):
#         if v < 0:
#             raise ValueError('–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º')
#         return v
#
#     @field_validator('name_stage', 'desc', 'duration')
#     @classmethod
#     def validate_not_empty(cls, v):
#         if not v or not v.strip():
#             raise ValueError('–ü–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º')
#         return v
#
#     class Config:
#         from_attributes = True
#
#
# class StageTemplateWithTemplates(StageTemplateBase):  # –ë–´–õ–û: StageWithTemplates
#     attribute_templates: List[AttributeTemplateResponse] = []
#
#
# class StageTemplateCreate(StageTemplateBase):  # –ë–´–õ–û: StageCreate
#     pass
#
#
# class StageTemplateResponse(StageTemplateBase):  # –ë–´–õ–û: StageResponse
#     case_template_id: int  # –ë–´–õ–û: case_id
#
#
# class CaseTemplateBase(BaseModel):  # –ë–´–õ–û: CaseBase
#     name: str
#     description: str
#
#
# class CaseTemplateCreate(CaseTemplateBase):  # –ë–´–õ–û: CaseCreate
#     stages: List[StageTemplateBase]  # –ë–´–õ–û: StageBase
#
#
# class CaseTemplateResponse(CaseTemplateBase):  # –ë–´–õ–û: CaseResponse
#     id: int
#     stages_list: str
#
#
# class ExportData(BaseModel):
#     name: str
#     description: str
#     stages: List[StageTemplateWithTemplates]  # –ë–´–õ–û: StageWithTemplates
#
#
# # –ú–æ–¥–µ–ª–∏ –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
# class ExecutorBase(BaseModel):
#     login: str
#     full_name: str
#     expert_area: Optional[str] = None
#
#
# class ExecutorCreate(ExecutorBase):
#     password: str
#
#
# class ExecutorResponse(ExecutorBase):
#     id: int
#     created_by: str
#
#     class Config:
#         from_attributes = True
#



import { useState, useEffect } from "react"; // –î–æ–±–∞–≤–ª—è–µ–º useEffect
import Button from "./Button/Button";

export default function FeedbackSection({onAuthorizationSuccess, login_user }) {
    const [form, setForm] = useState({
        name: "",
        password: "",
        nameHasError: true,
        passwordHasError: true
    });

    const [isLoading, setIsLoading] = useState(false);
    const [showPassword, setShowPassword] = useState(false);

    const handleNameChange = (event) => {
        const value = event.target.value;
        setForm(prev => ({
            ...prev,
            name: value,
            nameHasError: value.trim().length === 0
        }));
    };

    const handlePasswordChange = (event) => {
        const value = event.target.value;
        setForm(prev => ({
            ...prev,
            password: value,
            passwordHasError: value.trim().length === 0 || value.length < 6
        }));
    };

    const togglePasswordVisibility = () => {
        setShowPassword(!showPassword);
    };

    const isFormInvalid = form.nameHasError || form.passwordHasError;



    const isTokenExpired = (token) => {
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    const exp = payload.exp * 1000; // Convert to milliseconds
    return Date.now() >= exp;
  } catch (error) {
    console.error('Error checking token expiration:', error);
    return true;
  }
};





    const handleLoginClick = async () => {
        if (isFormInvalid) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
            return;
        }

        setIsLoading(true);

        try {
            const response = await fetch('http://localhost:8000/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: form.name,
                    password: form.password
                }),
            });

            if (response.ok) {
                const data = await response.json();

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('username', data.username);
                localStorage.setItem('user_role', data.role);

                // –í—ã–∑—ã–≤–∞–µ–º –∫–æ–ª–±—ç–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                onAuthorizationSuccess("authorized");
                login_user({
                    username: data.username,
                    role: data.role,
                    token: data.access_token
                });

                alert(`–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.username} (${data.role})`);
            } else {
                const error = await response.json();
                alert(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.detail || "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É');
        } finally {
            setIsLoading(false);
        }
    };

    const handleLogout = () => {
        // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
        localStorage.removeItem('access_token');
        localStorage.removeItem('username');
        localStorage.removeItem('user_role');

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        setForm({
            name: "",
            password: "",
            nameHasError: true,
            passwordHasError: true
        });

        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        onAuthorizationSuccess("unauthorized");
        login_user(null);

        alert("–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã");
    };

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    const checkExistingAuth = () => {
  const token = localStorage.getItem('access_token');
  const username = localStorage.getItem('username');
  const role = localStorage.getItem('user_role');

  if (token && username) {
    if (isTokenExpired(token)) {
      console.log('Token expired, logging out...');
      handleLogout();
      return;
    }

    onAuthorizationSuccess("authorized");
    login_user({
      username: username,
      role: role,
      token: token
    });
  }
};

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º useEffect –≤–º–µ—Å—Ç–æ useState –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    useEffect(() => {
        checkExistingAuth();
    }, []); // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π = –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

    return (
        <div style={{ padding: '20px', maxWidth: '400px', margin: '0 auto' }}>
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>

            <div style={{ marginBottom: '15px' }}>
                <label htmlFor="username" style={{ display: 'block', marginBottom: '5px' }}>
                    –õ–æ–≥–∏–Ω:
                </label>
                <input
                    id="username"
                    type="text"
                    value={form.name}
                    onChange={handleNameChange}
                    style={{
                        width: '100%',
                        padding: '8px',
                        border: form.nameHasError ? '1px solid red' : '1px solid #ccc',
                        borderRadius: '4px'
                    }}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω"
                    disabled={isLoading}
                />
                {form.nameHasError && (
                    <span style={{ color: 'red', fontSize: '12px' }}>
                        –ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                    </span>
                )}
            </div>

            <div style={{ marginBottom: '15px', position: 'relative' }}>
                <label htmlFor="password" style={{ display: 'block', marginBottom: '5px' }}>
                    –ü–∞—Ä–æ–ª—å:
                </label>
                <div style={{ position: 'relative' }}>
                    <input
                        id="password"
                        type={showPassword ? "text" : "password"}
                        value={form.password}
                        onChange={handlePasswordChange}
                        style={{
                            width: '100%',
                            padding: '8px',
                            paddingRight: '40px', // –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –∏–∫–æ–Ω–∫–∏
                            border: form.passwordHasError ? '1px solid red' : '1px solid #ccc',
                            borderRadius: '4px'
                        }}
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        disabled={isLoading}
                    />
                    <button
                        type="button"
                        onClick={togglePasswordVisibility}
                        style={{
                            position: 'absolute',
                            right: '8px',
                            top: '50%',
                            transform: 'translateY(-50%)',
                            background: 'none',
                            border: 'none',
                            cursor: 'pointer',
                            fontSize: '18px',
                            padding: '4px',
                            borderRadius: '3px',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            width: '30px',
                            height: '30px'
                        }}
                        title={showPassword ? "–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å" : "–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å"}
                        disabled={isLoading}
                    >
                        {showPassword ? (
                            <span style={{ fontSize: '18px' }}>üëÅÔ∏è</span> // –û—Ç–∫—Ä—ã—Ç—ã–π –≥–ª–∞–∑
                        ) : (
                            <span style={{ fontSize: '18px' }}>üîí</span> // –ó–∞–∫—Ä—ã—Ç—ã–π –≥–ª–∞–∑/–∑–∞–º–æ–∫
                        )}
                    </button>
                </div>
                {form.passwordHasError && (
                    <span style={{ color: 'red', fontSize: '12px' }}>
                        –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤
                    </span>
                )}
            </div>

            <Button
                onClick={handleLoginClick}
                disabled={isFormInvalid || isLoading}
                style={{
                    width: '100%',
                    marginBottom: '10px'
                }}
            >
                {isLoading ? '–í—Ö–æ–¥...' : '–í–æ–π—Ç–∏'}
            </Button>

            <Button
                onClick={handleLogout}
                style={{
                    width: '100%',
                    backgroundColor: '#dc3545'
                }}
            >
                –í—ã–π—Ç–∏
            </Button>

            <div style={{ marginTop: '15px', fontSize: '12px', color: '#666' }}>
                <p>–¢–µ—Å—Ç–æ–≤—ã–µ —É—á–µ—Ç–Ω—ã–µ –∑–∞–ø–∏—Å–∏:</p>
                <ul>
                    <li>admin / admintestpassword (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)</li>
                    <li>executor_1 / executortestpassword (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)</li>
                </ul>
            </div>
        </div>
    );
}